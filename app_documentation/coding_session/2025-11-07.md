# Coding Session - November 7, 2025

## Objective
Consolidate all data mutations to Server Actions pattern and clean up unused API routes.

---

## Cleanup & Refactoring: API Routes to Server Actions

**Goal**: Consolidate API operations to Server Actions pattern for consistency (following Phase 3).

### Subtasks

#### Cleanup 1: Delete Unused API Routes
- [x] Delete `/app/api/experiences/route.ts` (replaced by Server Actions in Phase 3)
- [x] Delete `/app/api/experiences/[id]/route.ts` (replaced by Server Actions in Phase 3)
- [x] Delete `/app/api/skills/route.ts` (replaced by Server Actions in Phase 3)
- [x] Delete `/app/api/skills/[id]/route.ts` (replaced by Server Actions in Phase 3)
- [x] Delete `/app/api/profile/route.ts` (replaced by Server Action)
- [x] Keep `/app/api/profile/completeness` (read-only, used by ProfileCompleteness component)

#### Cleanup 2: Create updateProfile Server Action
- [x] Create `/app/actions/profile.ts`
- [x] Implement `updateProfile(data: UpdateProfileInput)` Server Action
- [x] Validate input with Zod schema
- [x] Authenticate user
- [x] Update user_profiles in database
- [x] Call `updateProfileCompleteness()` to recalculate score
- [x] Call `revalidatePath("/app/profile")` for targeted refresh
- [x] Throw specific error messages on failure

#### Cleanup 3: Convert ProfileForm to Server Actions
- [x] Import `updateProfile` Server Action
- [x] Replace fetch API call with Server Action
- [x] Simplify error handling (throw/catch pattern like ExperienceForm)
- [x] Remove API response parsing
- [x] Build succeeds with no errors

#### Cleanup 4: Verify Pattern Consistency
- [x] ProfileForm uses Server Actions ✅
- [x] ExperienceForm uses Server Actions ✅
- [x] ExperienceList uses Server Actions ✅
- [x] SkillsInput uses Server Actions ✅
- [x] SkillsList uses Server Actions ✅
- [x] All follow same pattern: validate → DB operation → `revalidatePath()`
- [x] No full-page reloads on any update

---

## ✅ Cleanup Complete!

Successfully consolidated all write operations to Server Actions pattern:
- Deleted 5 unused API routes (experiences, skills, profile)
- Created `updateProfile` Server Action
- Converted ProfileForm to use Server Actions
- All components now follow consistent pattern
- No unused code in codebase

### Server Actions Pattern Summary
All mutations now follow this pattern:
1. Client calls Server Action
2. Server Action validates data (Zod)
3. Server Action performs DB operation
4. Server Action updates related data (profile completeness)
5. Server Action calls `revalidatePath()` for cache refresh
6. Component shows success/error message
7. **No full-page reload** - only affected data refreshes

### Commits
- `74c8a36` - refactor: Consolidate API operations to Server Actions pattern

---

---

## Phase 4: Search Criteria & Preferences

**Goal**: Build search criteria feature following the Server Actions pattern established in Phase 3.

### Subtasks

#### 4.1 Search Criteria Server Actions

Create Server Actions for search criteria management.

**Subtasks:**
- [ ] Create `/lib/validations/searchCriteria.ts`
  - Define Zod schema `SearchCriteriaInput` with all fields from `search_criteria` table
  - Validation: `target_job_titles` required (non-empty array), `work_models` required (at least one), `salary_min < salary_max` if both set
  - Export TypeScript type `SearchCriteriaInput`

- [ ] Create `/app/actions/searchCriteria.ts`
  - Implement `updateSearchCriteria(data: SearchCriteriaInput)` Server Action
    - Authenticate user
    - Validate with Zod schema
    - Upsert into `search_criteria` table (one row per user)
    - Call `revalidatePath("/app/search-criteria")`
  - Implement `toggleSearchActive(isActive: boolean)` Server Action
    - Authenticate user
    - Update `search_criteria.is_active`
    - Call `revalidatePath("/app/search-criteria")`

- [ ] Create `/lib/utils/generateMatchingInstructions.ts`
  - Function: `regenerateMatchingInstructions(userId: string)`
  - Convert search criteria fields into clear, structured text (max 500 chars)
  - Format: "Looking for: [titles]. Industries: [industries]. Level: [seniority]. Locations: [locations]. Remote: [models]. Salary: [min-max]. Must have: [requirements]. Dealbreakers: [dealbreakers]."
  - Call within `updateSearchCriteria` before `revalidatePath`

---

#### 4.2 Search Criteria UI Components

Create individual input components for search fields (following Phase 3 patterns from ExperienceForm).

**Subtasks:**
- [ ] Create `/components/features/search/` directory with input components:
  - `JobTitlesInput.tsx` - tag-based multi-select (required, min 1)
  - `IndustriesInput.tsx` - dropdown multi-select (optional)
  - `SeniorityInput.tsx` - checkbox multi-select (optional)
  - `LocationsInput.tsx` - tag-based multi-select (optional)
  - `WorkModelInput.tsx` - checkboxes: Remote, Hybrid, Onsite (required, min 1)
  - `SalaryRangeInput.tsx` - min/max inputs + currency selector (optional, validate min < max)
  - `ContractTypesInput.tsx` - checkbox multi-select (optional)
  - `KeywordsInput.tsx` - comma-separated or tag input (optional)
  - `IdealRoleInput.tsx` - textarea (optional, max 500 chars)
  - `MustHavesInput.tsx` - textarea (optional, max 500 chars)
  - `DealBreakersInput.tsx` - textarea (optional, max 500 chars)
  - `WorkEnvironmentInput.tsx` - textarea (optional, max 500 chars)
  - `YearsOfExperienceInput.tsx` - number input (optional, 0-60)
  - `WillingToRelocateInput.tsx` - toggle checkbox (optional)

**Requirements for all components:**
- Accept `value`, `onChange`, `error` props
- Use design system (Input, Card, Button components)
- Show error text in red below field if error exists
- Consistent spacing (Tailwind classes)
- Helper text/labels
- Responsive design

---

#### 4.3 Search Criteria Page & Form

Create main search criteria page with form component.

**Subtasks:**
- [ ] Create `/components/features/search/SearchCriteriaForm.tsx`
  - Main form wrapper managing all field states (like ExperienceForm)
  - State: formData, errors, isLoading, message
  - Organize inputs into 5 sections:
    1. Job Information (titles, industries, seniority, years_of_experience)
    2. Location & Work (locations, work_models, willing_to_relocate)
    3. Compensation (salary_min, salary_max, salary_currency)
    4. Contract & Keywords (contract_types, important_keywords)
    5. Role Description (ideal_role_description, must_have_requirements, must_not_have_requirements, work_environment_preferences)
  - Handle form submit: validate client-side → call `updateSearchCriteria()` → show success/error
  - "Save Changes" button (disabled while loading or invalid)
  - No success banners (clean UX, like Phase 3)

- [ ] Create `/app/dashboard/search-criteria/page.tsx`
  - Fetch current search criteria on page load
  - Handle loading state
  - Render SearchCriteriaForm with current data
  - Add page title "Search Criteria" + subtitle
  - Responsive layout

- [ ] Update sidebar navigation
  - Add "Search Criteria" link pointing to `/app/dashboard/search-criteria`

---

#### 4.4 Search Criteria Validation

Implement client-side and server-side validation with clear error messages.

**Subtasks:**
- [ ] Client-side validation in SearchCriteriaForm:
  - Real-time validation as user types
  - Required fields: `target_job_titles` (min 1), `work_models` (min 1)
  - Conditional: `salary_min < salary_max` if both set
  - Show inline error text (red) under invalid fields
  - Disable "Save Changes" button if any required field invalid
  - Show specific error messages ("At least one job title required", etc.)

- [ ] Server-side validation in `updateSearchCriteria()` Server Action:
  - Validate all required fields present
  - Validate `salary_min < salary_max`
  - Validate at least one `work_model` selected
  - Sanitize text inputs (trim, remove excess whitespace)
  - Throw specific error messages

- [ ] Profile completeness check for "Run Search Now":
  - Create `/lib/utils/isProfileComplete.ts`
  - Function: `checkProfileCompleteness(userId: string)` returns boolean
  - Before enabling "Run Search Now" button: check if profile completeness = 100%
  - Show inline error if not eligible: "Complete your profile (X% done) before searching"

---

## Technical Notes for Phase 4

**Pattern to follow (from Phase 3):**
- Server Actions for all write operations
- `revalidatePath()` for targeted cache refresh (not full page reload)
- Form component manages local state + validation
- No success banners (cleaner UX)
- Error messages shown inline in components
- Client validates first, server validates again (defense in depth)

**Database details:**
- `search_criteria` table: one row per user (unique constraint on `user_id`)
- Upsert logic: `insert().on_conflict("user_id").do_update(set: {...})`
- Fields in database: see database_tables.md lines 49-75

**Form structure pattern (from Phase 3 ExperienceForm):**
- Local state for form fields
- Errors state for validation feedback
- Loading state during submission
- Message state for error/success display
- Handle submit: validate → call Server Action → catch errors → show message
